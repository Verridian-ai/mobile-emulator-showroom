<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¤– AI Agent Factory - Mobile Device Testing Platform</title>
    <!-- Favicons - Using optimized PNG -->
    <link rel="icon" type="image/png" sizes="32x32" href="/public/new_electronic_logo.optimized.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/public/new_electronic_logo.optimized.png">
    <link rel="apple-touch-icon" href="/public/new_electronic_logo.optimized.png">
    <link rel="icon" type="image/png" href="/public/new_electronic_logo.optimized.png">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/src/styles/device-skins.css">
    <link rel="stylesheet" href="/src/styles/verridian-theme.css">
    <link rel="stylesheet" href="/src/styles/verridian-production.css">
    <link rel="stylesheet" href="/src/styles/verridian-media-optimized.css">

    <!-- Global Configuration -->
    <script>
        // Set global WebSocket token for all components
        window.WEBSOCKET_TOKEN = 'devtoken123';
        window.BROKER_PORT = 7071;
        window.APP_PORT = 4176;
    </script>

    <!-- Scripts - Vite will handle module bundling -->
    <script type="module" src="/src/js/security-config.js"></script>
    <script type="module" src="/src/js/performance-monitor.js"></script>

    <!-- Enhanced WebSocket Protocol Components -->
    <script type="module" src="/src/js/websocket-broker-stability-agent.js"></script>
    <script type="module" src="/src/js/enhanced-protocol-integration-bridge.js"></script>
    
    <!-- Removed dev-only Button Test Script -->
    <style>
        /* Override any conflicting base styles */
        .device-frame {
            transform: scale(0.8);
            transition: all 0.5s var(--transition-smooth);
        }
        
        .device-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        @media (max-width: 768px) {
            .device-frame {
                transform: scale(0.6);
            }
        }

        /* Loader progress styles */
        .loader-progress {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            width: min(420px, 80vw);
            margin-top: 20px;
            padding: 18px 20px;
            border-radius: 16px;
            background: rgba(10, 0, 32, 0.35);
            backdrop-filter: blur(14px) saturate(160%);
            -webkit-backdrop-filter: blur(14px) saturate(160%);
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 12px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.08);
        }
        .progress-ring { position: relative; filter: drop-shadow(0 0 16px rgba(107,70,193,0.6)) drop-shadow(0 0 28px rgba(37,99,235,0.5)); }
        .progress-ring svg { width: 180px; height: 180px; transform: rotate(-90deg); }
        .progress-ring .ring-bg { fill: none; stroke: rgba(255,255,255,0.12); stroke-width: 12; }
        .progress-ring .ring-fill { fill: none; stroke: url(#loaderGrad); stroke-width: 12; stroke-linecap: round; }
        .progress-ring::before {
            content: '';
            position: absolute; inset: -12px;
            border-radius: 999px;
            background: conic-gradient(from 0deg, rgba(255,255,255,0.0) 0deg, rgba(107,70,193,0.35) 60deg, rgba(37,99,235,0.35) 120deg, rgba(255,255,255,0.0) 180deg);
            filter: blur(10px);
            animation: loaderSpin 2.8s linear infinite;
            pointer-events: none; mix-blend-mode: screen;
        }
        .progress-ring .percent-text {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            font-family: 'BraveEightyone', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 2rem; letter-spacing: 1px; text-shadow: 0 0 10px rgba(107,70,193,0.6), 0 0 18px rgba(37,99,235,0.5);
        }
        .progress-bar { width: 100%; height: 12px; border-radius: 999px; background: rgba(255,255,255,0.06); overflow: hidden; border: 1px solid rgba(255,255,255,0.15); box-shadow: inset 0 1px 0 rgba(255,255,255,0.08); }
        .progress-bar .progress-fill { position: relative; height: 100%; width: 0%; background: linear-gradient(90deg, #6B46C1, #2563EB); background-size: 200% 100%; box-shadow: 0 0 16px rgba(107,70,193,0.6); transition: width 120ms linear; animation: gradientMove 2.2s linear infinite; }
        .progress-bar .progress-fill::after { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(-45deg, rgba(255,255,255,0.22) 0 8px, rgba(255,255,255,0.0) 8px 16px); mix-blend-mode: overlay; animation: stripeMove 1s linear infinite; }
    </style>
</head>
<body>
    
    <div class="container">
        <!-- Premium Glass Header with Enhanced Depth System -->
        <header class="verridian-header glass-premium glass-crystal glass-depth-3" role="banner">
            <picture>
                <source srcset="/public/new_electronic_logo.optimized.webp" type="image/webp">
                <img src="/public/new_electronic_logo.optimized.png" alt="AI Agent Factory Logo" class="verridian-logo-enhanced" id="logo">
            </picture>
            <p class="verridian-subtitle">Device Testing Platform</p>
        </header>
        
        <!-- Main Control Section with Glass Hierarchy -->
        <main class="control-section">
            <div class="url-container">
                <input type="text" id="urlInput" class="url-input-cosmic" placeholder="Enter URL...">
                <button id="urlSubmit" class="url-submit-btn">
                    <span>&#10148;</span>
                </button>
            </div>
            
            <!-- Device Control Panel with Responsive Grid -->
            <div class="control-panel">
                <!-- iPhone Models with Premium Glass -->
                <div class="device-group-cosmic">
                    <h3 class="device-group-title">iPhone</h3>
                <button class="btn-cosmic" data-device="iphone-6">iPhone 6</button>
                <button class="btn-cosmic" data-device="iphone-7">iPhone 7</button>
                <button class="btn-cosmic" data-device="iphone-8">iPhone 8</button>
                <button class="btn-cosmic" data-device="iphone-x">iPhone X</button>
                <button class="btn-cosmic" data-device="iphone-11">iPhone 11</button>
                <button class="btn-cosmic" data-device="iphone-12">iPhone 12</button>
                <button class="btn-cosmic" data-device="iphone-13">iPhone 13</button>
                <button class="btn-cosmic" data-device="iphone-14">iPhone 14</button>
                <button class="btn-cosmic active" data-device="iphone-14-pro">iPhone 14 Pro</button>
                <button class="btn-cosmic" data-device="iphone-15">iPhone 15</button>
                <button class="btn-cosmic" data-device="iphone-15-pro">iPhone 15 Pro</button>
                <button class="btn-cosmic" data-device="iphone-16-pro">iPhone 16 Pro</button>
            </div>
            
            <!-- Samsung Galaxy with Enhanced Glass -->
            <div class="device-group-cosmic">
                <h3 class="device-group-title">Galaxy</h3>
                <button class="btn-cosmic" data-device="galaxy-s7">Galaxy S7</button>
                <button class="btn-cosmic" data-device="galaxy-s10">Galaxy S10</button>
                <button class="btn-cosmic" data-device="galaxy-s21">Galaxy S21</button>
                <button class="btn-cosmic" data-device="galaxy-s22">Galaxy S22</button>
                <button class="btn-cosmic" data-device="galaxy-s24">Galaxy S24</button>
                <button class="btn-cosmic" data-device="galaxy-s25-ultra">Galaxy S25 Ultra</button>
            </div>
            
            <!-- Google Pixel with Enhanced Glass -->
            <div class="device-group-cosmic">
                <h3 class="device-group-title">Pixel</h3>
                <button class="btn-cosmic" data-device="pixel-3">Pixel 3</button>
                <button class="btn-cosmic" data-device="pixel-5">Pixel 5</button>
                <button class="btn-cosmic" data-device="pixel-7">Pixel 7</button>
                <button class="btn-cosmic" data-device="pixel-8">Pixel 8</button>
                <button class="btn-cosmic" data-device="pixel-9-pro">Pixel 9 Pro</button>
            </div>
            
            <!-- iPads with Enhanced Glass -->
            <div class="device-group-cosmic">
                <h3 class="device-group-title">iPad</h3>
                <button class="btn-cosmic" data-device="ipad-air-2022">iPad Air 2022</button>
                <button class="btn-cosmic" data-device="ipad-pro-13-m4">iPad Pro 13" M4</button>
            </div>
            
            <!-- Desktop with Enhanced Glass -->
            <div class="device-group-cosmic">
                <h3 class="device-group-title">Desktop</h3>
                <button class="btn-cosmic" data-device="desktop-chrome">Desktop Chrome</button>
            </div>
        </div>
        </main>
        
        <!-- Device Showcase Section with Premium Glass -->
        <section class="device-showcase-cosmic glass-dark glass-depth-2">
            <div id="deviceFrame" class="device-mockup device-iphone-14-pro scale-75 animate-hover">
                <div class="screen">
                    <iframe id="deviceIframe" src="https://google.com"></iframe>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Constants to avoid magic numbers
        const CONFIG = {
            RECONNECT_DELAY: 5000,
            MIN_LOAD_TIME: 1500,
            IFRAME_REFRESH_DELAY: 250,
            LOADER_FADE_DURATION: 1000,
            PERFORMANCE_CHECK_INTERVAL: 1000,
            FPS_WARNING_THRESHOLD: 30,
            PARTICLE_REDUCTION_FACTOR: 0.8,
            BROKER_URL: 'ws://localhost:7071',
            BROKER_TOKEN: 'devtoken123'
        };
        
        const deviceFrame = document.getElementById('deviceFrame');
        const deviceButtons = document.querySelectorAll('[data-device]');
        const urlInput = document.getElementById('urlInput');
        const urlSubmit = document.getElementById('urlSubmit');

        // Function to update iframe URL
        const updateIframeUrl = () => {
            let url = urlInput.value.trim();
            const currentIframe = document.getElementById('deviceIframe');
            if (url && currentIframe) {
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                currentIframe.src = url;
            }
        };

        // Event listeners for URL submission
        urlSubmit.addEventListener('click', updateIframeUrl);
        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                updateIframeUrl();
            }
        });
        
        // Handle device switching with enhanced animations
        deviceButtons.forEach(btn => {
            // Add hover animations
            if (typeof motion !== 'undefined') {
                motion.gesture(btn, {
                    hover: { scale: 1.05, opacity: 0.9 },
                    tap: { scale: 0.95 },
                    initial: { scale: 1, opacity: 1 }
                });
            }
            
            btn.addEventListener('click', () => {
                // Animate button state change
                deviceButtons.forEach(b => {
                    b.classList.remove('active');
                    if (typeof motion !== 'undefined' && b !== btn) {
                        motion.spring(b, { opacity: 0.7 }, { spring: motion.springs.gentle });
                    }
                });
                
                btn.classList.add('active');
                if (typeof motion !== 'undefined') {
                    motion.spring(btn, { 
                        scale: 1.1,
                        opacity: 1 
                    }, { 
                        spring: motion.springs.bouncy 
                    }).then(() => {
                        motion.spring(btn, { scale: 1 }, { spring: motion.springs.snappy });
                    });
                }
                
                // Update device frame class with animation
                const deviceClass = btn.dataset.device;
                
                // Animate device frame transition
                if (typeof motion !== 'undefined') {
                    motion.spring(deviceFrame, {
                        opacity: 0,
                        scale: 0.95
                    }, {
                        spring: motion.springs.snappy,
                        duration: 200
                    }).then(() => {
                        // Update frame after fade out
                        updateDeviceFrame(deviceClass);
                        
                        // Animate back in
                        motion.spring(deviceFrame, {
                            opacity: 1,
                            scale: 1
                        }, {
                            spring: motion.springs.smooth,
                            duration: 300
                        });
                    });
                } else {
                    updateDeviceFrame(deviceClass);
                }
            });
        });
        
        // Helper function to update device frame (SECURITY ENHANCED)
        function updateDeviceFrame(deviceClass) {
                // Sanitize URL for display
                const sanitizeUrl = (url) => {
                    const div = document.createElement('div');
                    div.textContent = url;
                    return div.innerHTML;
                };
                
                // Cache current iframe source
                const currentSrc = deviceIframe ? deviceIframe.src : 'https://verridian.ai';
                
                // Clear existing content safely
                while (deviceFrame.firstChild) {
                    deviceFrame.removeChild(deviceFrame.firstChild);
                }
                
                // Update frame class
                deviceFrame.className = `device-mockup device-${deviceClass} scale-75 animate-hover`;
                
                // Build DOM structure programmatically (safer than innerHTML)
                if (deviceClass === 'desktop-chrome') {
                    // Create browser header
                    const browserHeader = document.createElement('div');
                    browserHeader.className = 'browser-header';
                    
                    const browserButtons = document.createElement('div');
                    browserButtons.className = 'browser-buttons';
                    ['close', 'minimize', 'maximize'].forEach(type => {
                        const button = document.createElement('span');
                        button.className = `browser-button ${type}`;
                        browserButtons.appendChild(button);
                    });
                    
                    const addressBar = document.createElement('div');
                    addressBar.className = 'browser-address-bar';
                    addressBar.textContent = currentSrc; // Safe text content
                    
                    browserHeader.appendChild(browserButtons);
                    browserHeader.appendChild(addressBar);
                    deviceFrame.appendChild(browserHeader);
                }
                
                // Create screen container
                const screen = document.createElement('div');
                screen.className = 'screen';
                
                // Create new iframe
                const newIframe = document.createElement('iframe');
                newIframe.id = 'deviceIframe';
                newIframe.src = currentSrc;
                newIframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms');
                newIframe.setAttribute('loading', 'lazy');
                
                screen.appendChild(newIframe);
                deviceFrame.appendChild(screen);
                
                // Update global reference
                window.deviceIframe = newIframe;
        }
        
        // Handle commands from agents
        const handleAgentCommand = (data) => {
            switch (data.command) {
                case 'open_url':
                    if (data.payload && data.payload.url) {
                        deviceIframe.src = data.payload.url;
                    }
                    break;
                case 'screenshot':
                    // For now, just log - would need server-side screenshot capability
                    console.log('Screenshot requested');
                    break;
                default:
                    console.log('Unknown command:', data.command);
            }
        };
        
        // Connect to broker on load
        connectToBroker();
    </script>
</body>
</html>